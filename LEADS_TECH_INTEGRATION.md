# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å leads.tech

## –û–±–∑–æ—Ä
–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–µ—Ç UTM –º–µ—Ç–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ VK Mini App –≤ —Å–∏—Å—Ç–µ–º—É –∞—Ä–±–∏—Ç—Ä–∞–∂–Ω–∏–∫–∞ leads.tech –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Å–∏–π –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
- –ü—Ä–∏ –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è UTM –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
- –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ VK Bridge
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ leads.tech —á–µ—Ä–µ–∑ –Ω–∞—à API

### 2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è leads.tech (—Ñ–æ—Ä–º–∞—Ç –æ—Ñ—Ñ–µ—Ä–æ–≤)
–°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ leads.tech:

```
https://–±–µ–∑–æ—Ç–∫–∞–∑–∞.–±–∞–±–∫–∏–º–∞–Ω–∫–∏.—Ä—Ñ/Eg5hd?s4=vk_bot_test&s5=vk_ads&s6=555555
```

- `s4` - `{ref}` (–∏—Å—Ç–æ—á–Ω–∏–∫ –ø–µ—Ä–µ—Ö–æ–¥–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä: `vk_bot_test`)
- `s5` - `{ref_source}` (—Ç–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä: `vk_ads`)
- `s6` - `{user_id}` (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è VK, –Ω–∞–ø—Ä–∏–º–µ—Ä: `555555`)

**‚ö†Ô∏è –í–∞–∂–Ω–æ:** –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã `{ref}`, `{ref_source}`, `{user_id}` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω—è—é—Ç—Å—è!

### 3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
–¢–∞–∫–∂–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è:
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ UTM –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (utm_source, utm_medium, utm_campaign, utm_content, utm_term)
- VK —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (vk_ad_id, vk_ref, vk_platform)
- –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–º—è, —Ñ–∞–º–∏–ª–∏—è, ID)
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (timestamp, URL, user_agent, IP)

## API Endpoints

### POST /api/arbitrage/send-to-leads-tech/
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ leads.tech

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "user_id": "123456789",
  "first_name": "–ò–≤–∞–Ω",
  "last_name": "–ò–≤–∞–Ω–æ–≤",
  "utm_source": "vk_ads",
  "utm_campaign": "spring_2025",
  "vk_ad_id": "ad_12345",
  "timestamp": "2025-01-04T12:00:00Z",
  "url": "https://vk.com/app123456",
  "user_agent": "Mozilla/5.0..."
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "message": "–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ leads.tech",
  "tracking_id": 234,
  "leads_tech_data": {...},
  "leads_tech_params": {
    "sub1": "babkimankirf",
    "sub2": "vk_bot_otkaz_1offer",
    "sub6": "123456789"
  },
  "leads_tech_url": "https://t.leads.tech/click/892/159/?sub1=babkimankirf&sub2=vk_bot_otkaz_1offer&sub6=123456789",
  "timestamp": "2025-01-04T12:00:00Z"
}
```

## Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### useArbitrageTracker —Ö—É–∫
```javascript
import useArbitrageTracker from './hooks/useArbitrageTracker';

const {
  sendToLeadsTech,
  autoSendOnUTMChange,
  generateArbitrageLink,
  isLoading,
  error,
  lastSentData
} = useArbitrageTracker();
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
```javascript
// –í App.jsx
useEffect(() => {
  if (userData && utmParams && Object.keys(utmParams).length > 0) {
    autoSendOnUTMChange(userData, utmParams);
  }
}, [userData, utmParams, autoSendOnUTMChange]);
```

## Backend –ª–æ–≥–∏–∫–∞

### 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è IP –∞–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è leads.tech
- –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

### 2. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ leads.tech
```python
leads_tech_url = f"https://t.leads.tech/click/892/159/"
leads_tech_params_url = leads_tech_url + "?" + "&".join([
    f"{key}={value}" for key, value in leads_tech_params.items() 
    if value  # –¢–æ–ª—å–∫–æ –Ω–µ–ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
])

leads_tech_response = requests.get(
    leads_tech_params_url,
    timeout=10,
    headers={
        'User-Agent': data.get('user_agent', ''),
        'Referer': data.get('referrer', ''),
    }
)
```

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É
–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `UTMTracking` –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:
- UTM –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- VK –ø–∞—Ä–∞–º–µ—Ç—Ä—ã  
- –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
- –¢–∏–ø —Å–æ–±—ã—Ç–∏—è: `arbitrage_send`

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
```
üìä –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ leads.tech: {...}
üîó –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ leads.tech: https://t.leads.tech/click/892/159/?sub1=babkimankirf&sub2=vk_bot_otkaz_1offer&sub6=123456789
‚úÖ –û—Ç–≤–µ—Ç –æ—Ç leads.tech: 200
‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ UTMTracking —Å ID: 234
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
```sql
SELECT * FROM api_utmtracking 
WHERE event_type = 'arbitrage_send' 
ORDER BY timestamp DESC;
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
```bash
python3 test_leads_tech_integration.py
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
curl -X POST http://localhost:8000/api/arbitrage/send-to-leads-tech/ \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "123456789",
    "first_name": "–¢–µ—Å—Ç",
    "utm_source": "vk_ads",
    "utm_campaign": "spring_2025"
  }'
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker

### docker-compose.yml
```yaml
backend:
  ports:
    - "8000:8000"  # –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
```bash
docker-compose restart backend
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- IP –∞–¥—Ä–µ—Å–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è gracefully
- Timeout 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VK —Ä–µ–∫–ª–∞–º—ã

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ UTM –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è VK (—Ñ–æ—Ä–º–∞—Ç –æ—Ñ—Ñ–µ—Ä–æ–≤)
–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å leads.tech –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ VK —Ä–µ–∫–ª–∞–º–µ:

```
https://vk.com/app123456?ref=vk_bot_test&ref_source=vk_ads&s4=vk_bot_test&s5=vk_ads&s6={user_id}
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–µ—Ç:
- `ref` ‚Üí `s4` (–∏—Å—Ç–æ—á–Ω–∏–∫ –ø–µ—Ä–µ—Ö–æ–¥–∞)
- `ref_source` ‚Üí `s5` (—Ç–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞)
- `user_id` ‚Üí `s6` (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è VK)

### –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫:

1. **VK —Ä–µ–∫–ª–∞–º–∞:**
```
https://vk.com/app123456?ref=vk_bot_test&ref_source=vk_ads&s4=vk_bot_test&s5=vk_ads&s6={user_id}
```

2. **VK Mini App:**
```
https://vk.com/app123456?ref=mini_app_test&ref_source=vk_mini&s4=mini_app_test&s5=vk_mini&s6={user_id}
```

3. **–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞:**
```
https://vk.com/app123456?ref=direct_test&ref_source=direct&s4=direct_test&s5=direct&s6={user_id}
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –í leads.tech –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã `{ref}`, `{ref_source}`, `{user_id}`
**–ü—Ä–∏—á–∏–Ω–∞:** UTM –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∏–ª–∏ –Ω–µ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
**–†–µ—à–µ–Ω–∏–µ:** 
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ URL –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `ref`, `ref_source`
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ VK (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è `user_id`)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ backend –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞: "Connection refused"
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω –∏ –ø–æ—Ä—Ç 8000 –ø—Ä–æ–±—Ä–æ—à–µ–Ω

### –ü—Ä–æ–±–ª–µ–º–∞: "UTMTracking() got unexpected keyword arguments"
**–†–µ—à–µ–Ω–∏–µ:** –£–±—Ä–∞—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è –∏–∑ –º–æ–¥–µ–ª–∏

### –ü—Ä–æ–±–ª–µ–º–∞: leads.tech –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
**–†–µ—à–µ–Ω–∏–µ:** –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑—É

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å leads.tech –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:
- URL: https://t.leads.tech/click/892/159/
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: sub1, sub2, sub3-sub8
