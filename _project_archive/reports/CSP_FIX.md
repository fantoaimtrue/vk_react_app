# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ê –û–®–ò–ë–ö–ê CSP (Content Security Policy)

**–î–∞—Ç–∞**: 8 –Ω–æ—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞**: `Refused to connect to unpkg.com` - CSP –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∑–∞–≥—Ä—É–∑–∫—É

---

## üî¥ –ß–¢–û –ë–´–õ–û

### –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:
```
Refused to connect to 'https://unpkg.com/@vkontakte/vk-bridge@2.6.0/dist/browser.min.js.map' 
because it violates the following Content Security Policy directive: "connect-src 'self'".
```

### –ü—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã:

#### 1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ VK Bridge
**–í index.html (—Å—Ç—Ä–æ–∫–∞ 15):**
```html
<script src="https://unpkg.com/@vkontakte/vk-bridge@2.6.0/dist/browser.min.js"></script>
```
‚ö†Ô∏è –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è 2.6.0 —á–µ—Ä–µ–∑ CDN (unpkg.com)

**–í package.json:**
```json
"@vkontakte/vk-bridge": "^2.15.7"
```
‚úÖ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è 2.15.7 —á–µ—Ä–µ–∑ npm

**–ü—Ä–æ–±–ª–µ–º–∞**: –ó–∞–≥—Ä—É–∂–∞–ª–æ—Å—å –¥–≤–∞–∂–¥—ã! –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª–∞ —Å –Ω–æ–≤–æ–π.

#### 2. –°—Ç—Ä–æ–≥–∏–π CSP –∑–∞–≥–æ–ª–æ–≤–æ–∫
**–í nginx-ssl-with-backend.conf:**
```nginx
connect-src 'self';
```
‚ùå –†–∞–∑—Ä–µ—à–∞–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–µ–º—É –¥–æ–º–µ–Ω—É, –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª unpkg.com

---

## ‚úÖ –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1. –£–¥–∞–ª—ë–Ω —Å—Ç–∞—Ä—ã–π —Å–∫—Ä–∏–ø—Ç –∏–∑ index.html

**–ë–´–õ–û:**
```html
<!-- VK Bridge —Å–∫—Ä–∏–ø—Ç -->
<script src="https://unpkg.com/@vkontakte/vk-bridge@2.6.0/dist/browser.min.js"></script>
```

**–°–¢–ê–õ–û:**
```html
<!-- VK Bridge –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ npm (@vkontakte/vk-bridge@2.15.7) –≤ –∫–æ–¥–µ -->
<!-- –°—Ç–∞—Ä—ã–π —Å–∫—Ä–∏–ø—Ç —É–¥–∞–ª—ë–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è -->
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≤–µ—Ä—Å–∏—è VK Bridge (2.15.7)
- ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Vite bundle
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤–µ—Ä—Å–∏–π
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ (–º–µ–Ω—å—à–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç offline (–≤ bundle)

### 2. –û–±–Ω–æ–≤–ª—ë–Ω CSP –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ Nginx

**–ë–´–õ–û:**
```nginx
connect-src 'self';
```

**–°–¢–ê–õ–û:**
```nginx
connect-src 'self' https://*.vk.com https://*.vk.ru https://t.leads.tech https://bodyexp.ru;
```

**–ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–∑—Ä–µ—à–µ–Ω–æ:**
- ‚úÖ `'self'` - —Å–≤–æ–π –¥–æ–º–µ–Ω (bodyexp.ru)
- ‚úÖ `https://*.vk.com` - –≤—Å–µ –ø–æ–¥–¥–æ–º–µ–Ω—ã VK
- ‚úÖ `https://*.vk.ru` - –≤—Å–µ –ø–æ–¥–¥–æ–º–µ–Ω—ã VK.ru
- ‚úÖ `https://t.leads.tech` - Leads.Tech API
- ‚úÖ `https://bodyexp.ru` - –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω

### 3. –î–æ–±–∞–≤–ª–µ–Ω–æ script-src

**–ë–´–õ–û:**
```nginx
(–Ω–µ –±—ã–ª–æ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤)
```

**–°–¢–ê–õ–û:**
```nginx
script-src 'self' 'unsafe-inline';
```

–†–∞–∑—Ä–µ—à–∞–µ—Ç:
- ‚úÖ –°–∫—Ä–∏–ø—Ç—ã —Å –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞
- ‚úÖ Inline —Å–∫—Ä–∏–ø—Ç—ã (–¥–ª—è Vite HMR)

---

## üéØ –ü–û–õ–ù–´–ô CSP –ó–ê–ì–û–õ–û–í–û–ö

```nginx
Content-Security-Policy: 
  frame-ancestors 'self' https://vk.com https://m.vk.com https://vk.ru https://m.vk.ru;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com;
  script-src 'self' 'unsafe-inline';
  connect-src 'self' https://*.vk.com https://*.vk.ru https://t.leads.tech https://bodyexp.ru;
```

### –ß—Ç–æ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:

| –î–∏—Ä–µ–∫—Ç–∏–≤–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –ó–∞—á–µ–º |
|-----------|----------|-------|
| `frame-ancestors` | VK –¥–æ–º–µ–Ω—ã | –†–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –≤ iframe VK |
| `style-src` | Google Fonts + inline | –î–ª—è —Å—Ç–∏–ª–µ–π |
| `font-src` | Google Fonts | –î–ª—è —à—Ä–∏—Ñ—Ç–æ–≤ |
| `script-src` | self + inline | –î–ª—è JS —Å–∫—Ä–∏–ø—Ç–æ–≤ |
| `connect-src` | VK + Leads.Tech | –î–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ ‚úÖ |

---

## üß™ –ü–†–û–í–ï–†–ö–ê

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ VK Bridge:
```javascript
// –û—Ç–∫—Ä–æ–π—Ç–µ https://bodyexp.ru –≤ –±—Ä–∞—É–∑–µ—Ä–µ
// –ö–æ–Ω—Å–æ–ª—å (F12) –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç—å:
‚úÖ VK Bridge –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–≤–µ—Ä—Å–∏—è 2.15.7)
‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ CSP
‚úÖ API –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ CSP –∑–∞–≥–æ–ª–æ–≤–∫–∞:
```bash
curl -I https://bodyexp.ru | grep Content-Security-Policy
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
Content-Security-Policy: frame-ancestors 'self' https://vk.com ...; connect-src 'self' https://*.vk.com ...
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ—à–∏–±–æ–∫:
```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
https://bodyexp.ru

# –í –∫–æ–Ω—Å–æ–ª–∏ (F12) –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
‚ùå "Refused to connect..."
‚ùå "violates CSP directive"
```

---

## üìä –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå VK Bridge 2.6.0 (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π) —á–µ—Ä–µ–∑ CDN
- ‚ùå VK Bridge 2.15.7 —á–µ—Ä–µ–∑ npm (–∫–æ–Ω—Ñ–ª–∏–∫—Ç –≤–µ—Ä—Å–∏–π!)
- ‚ùå CSP –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª external —Ä–µ—Å—É—Ä—Å—ã
- ‚ùå –û—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
- ‚ùå Source maps –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ VK Bridge 2.15.7 (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π) —á–µ—Ä–µ–∑ npm
- ‚úÖ –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≤–µ—Ä—Å–∏—è (–Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
- ‚úÖ CSP —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –Ω—É–∂–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏
- ‚úÖ API –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ (–º–µ–Ω—å—à–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤)

---

## üîí –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### CSP –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç:
- ‚úÖ **XSS –∞—Ç–∞–∫** - —Å–∫—Ä–∏–ø—Ç—ã —Ç–æ–ª—å–∫–æ —Å –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤
- ‚úÖ **Clickjacking** - frame-ancestors –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç iframe
- ‚úÖ **Data injection** - –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **Man-in-the-middle** - —Ç–æ–ª—å–∫–æ HTTPS –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã:
- `vk.com`, `vk.ru` - VK API –∏ VK Bridge
- `t.leads.tech` - Leads.Tech –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- `bodyexp.ru` - –≤–∞—à –¥–æ–º–µ–Ω
- `fonts.googleapis.com` - —à—Ä–∏—Ñ—Ç—ã Google

**–í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!** üõ°Ô∏è

---

## üéì –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò VK BRIDGE

### –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ npm –≤–µ—Ä—Å–∏—é (–∫–∞–∫ —Å–µ–π—á–∞—Å):

```javascript
// src/app.jsx
import vkBridge from '@vkontakte/vk-bridge';

vkBridge.send('VKWebAppInit');
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
- ‚úÖ TypeScript –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- ‚úÖ Tree-shaking (–º–µ–Ω—å—à–µ bundle)
- ‚úÖ Offline —Ä–∞–±–æ—Ç–∞
- ‚úÖ –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç CDN

### –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ CDN –≤–µ—Ä—Å–∏—é:

```html
<!-- ‚ùå –ù–ï –î–ï–õ–ê–ô–¢–ï –¢–ê–ö -->
<script src="https://unpkg.com/@vkontakte/vk-bridge@2.6.0/dist/browser.min.js"></script>
```

**–ú–∏–Ω—É—Å—ã CDN:**
- ‚ùå –£—Å—Ç–∞—Ä–µ–≤—à–∞—è –≤–µ—Ä—Å–∏—è
- ‚ùå –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç unpkg.com
- ‚ùå CSP –ø—Ä–æ–±–ª–µ–º—ã
- ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å npm –≤–µ—Ä—Å–∏–µ–π
- ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–µ–µ (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å)

---

## üìã –ß–ï–ö–õ–ò–°–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

- [x] ‚úÖ –£–¥–∞–ª—ë–Ω —Å—Ç–∞—Ä—ã–π VK Bridge —Å–∫—Ä–∏–ø—Ç –∏–∑ index.html
- [x] ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω CSP –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ nginx
- [x] ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω—ã VK –¥–æ–º–µ–Ω—ã –≤ connect-src
- [x] ‚úÖ –†–∞–∑—Ä–µ—à—ë–Ω Leads.Tech –≤ connect-src
- [x] ‚úÖ Frontend –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω
- [x] ‚úÖ Production –æ–±–Ω–æ–≤–ª—ë–Ω
- [x] ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

## üéä –ò–¢–û–ì–ò

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é!

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –û—à–∏–±–∫–∞ CSP –±–æ–ª—å—à–µ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è
- ‚úÖ VK Bridge —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–≤–µ—Ä—Å–∏—è 2.15.7)
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –≤–µ—Ä—Å–∏–π
- ‚úÖ API –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** 100% üöÄ

---

**–î–∞—Ç–∞**: 8 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ CSP –∏—Å–ø—Ä–∞–≤–ª–µ–Ω, VK Bridge –æ–±–Ω–æ–≤–ª—ë–Ω  
**–§–∞–π–ª—ã**: index.html, nginx-ssl-with-backend.conf

